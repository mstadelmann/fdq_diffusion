{
    "globals": {
        "project": "CBCT_Diff_Gen",
        "author": "Marc"
    },
    "transforms": {
        "HU_to_norm": [
            "Float32",
            {
                "ReRange": {
                    "in_min": -1500,
                    "in_max": 1000,
                    "out_min": -1,
                    "out_max": 1
                }
            }
        ],
        "norm_to_HU": [
            {
                "ReRange": {
                    "in_min": -1,
                    "in_max": 1,
                    "out_min": -1500,
                    "out_max": 1000
                }
            }
        ],
        "extract_2d_from_3d": [
            {
                "Get2DFrom3D": {
                    "axis": 2
                }
            }
        ]
    },
    "data": {
        "ctrate": {
            "processor": "~/dev/fdq_diffusion/hdf_preparator_v2.py",
            "args": {
                "train_files_path": [
                    "/cluster/projects/ac3t/data/ac3t_ct_rate/size_256/v03/final_hdfs/nproj_491/ct_rate_train_batch_0_v03.hdf",
                    "/cluster/projects/ac3t/data/ac3t_ct_rate/size_256/v03/final_hdfs/nproj_491/ct_rate_train_batch_1_v03.hdf",
                    "/cluster/projects/ac3t/data/ac3t_ct_rate/size_256/v03/final_hdfs/nproj_491/ct_rate_train_batch_2_v03.hdf",
                    "/cluster/projects/ac3t/data/ac3t_ct_rate/size_256/v03/final_hdfs/nproj_491/ct_rate_train_batch_3_v03.hdf",
                    "/cluster/projects/ac3t/data/ac3t_ct_rate/size_256/v03/final_hdfs/nproj_491/ct_rate_train_batch_4_v03.hdf",
                    "/cluster/projects/ac3t/data/ac3t_ct_rate/size_256/v03/final_hdfs/nproj_491/ct_rate_train_batch_5_v03.hdf"
                ],
                "test_files_path": [
                    "/cluster/projects/ac3t/data/ac3t_ct_rate/size_256/v03/final_hdfs/nproj_491/ct_rate_test_batch_0_v03.hdf",
                    "/cluster/projects/ac3t/data/ac3t_ct_rate/size_256/v03/final_hdfs/nproj_491/ct_rate_test_batch_1_v03.hdf",
                    "/cluster/projects/ac3t/data/ac3t_ct_rate/size_256/v03/final_hdfs/nproj_491/ct_rate_test_batch_2_v03.hdf",
                    "/cluster/projects/ac3t/data/ac3t_ct_rate/size_256/v03/final_hdfs/nproj_491/ct_rate_test_batch_3_v03.hdf"
                ],
                "hdf_ds_key_request": [
                    {
                        "Vol_full": "HU_to_norm"
                    }
                ],
                "hdf_ds_key_request_test": [
                    {
                        "Vol_full": "HU_to_norm"
                    }
                ],
                "data_is_3d": true,
                "file_extension": "hdf",
                "val_from_train_ratio": 0.1,
                "subset_train": 1.0,
                "subset_val": 1.0,
                "subset_test": 1.0,
                "pin_memory": true,
                "num_workers": 4,
                "train_batch_size": 1,
                "val_batch_size": 1,
                "test_batch_size": 1,
                "shuffle_train": true,
                "shuffle_val": false,
                "shuffle_test": false,
                "drop_last": true
            }
        }
    },
    "models": {
        "monaiUNET": {
            "class_name": "monai.networks.nets.DiffusionModelUNet",
            "args": {
                "spatial_dims": 3,
                "in_channels": 1,
                "out_channels": 1,
                "resblock_updown": true,
                "num_res_blocks": [
                    2,
                    2,
                    2,
                    2
                ],
                "channels": [
                    64,
                    128,
                    256,
                    512
                ],
                "attention_levels": [
                    false,
                    false,
                    false,
                    false
                ]
            },
            "optimizer": {
                "class_name": "torch.optim.Adam",
                "args": {
                    "lr": 0.0001
                }
            },
            "lr_scheduler": {
                "class_name": "torch.optim.lr_scheduler.StepLR",
                "args": {
                    "step_size": 20,
                    "gamma": 0.95
                }
            }
        }
    },
    "train": {
        "path": "~/dev/fdq_diffusion/diffusion_monai.py",
        "args": {
            "epochs": 200,
            "use_GPU": true,
            "use_AMP": true,
            "accumulate_grad_batches": 1,
            "early_stop_val_loss": 50,
            "early_stop_train_loss": 20,
            "early_stop_nan": 5,
            "dataloader_name": "ctrate",
            "model_name": "monaiUNET",
            "diffusion_nb_steps": 800,
            "diffusion_nb_plot_steps": 10,
            "diffusion_scheduler": "linear_beta",
            "diffusion_scheduler_args": {
                "beta_start": 0.0001,
                "beta_end": 0.02
            }
        }
    },
    "losses": {
        "MAE": {
            "class_name": "torch.nn.L1Loss"
        },
        "MSE": {
            "class_name": "torch.nn.MSELoss"
        }
    },
    "store": {
        "results_path": "~/data/ML_data/results",
        "img_exp_nb": 8,
        "save_last_model": true,
        "save_best_val_model": true,
        "save_best_train_model": true,
        "checkpoint_frequency": 5,
        "use_tensorboard": false,
        "use_wandb": true,
        "wandb_project": "diff_gen_cbct_x256",
        "wandb_entity": "stmd",
        "wandb_key": "126aea51c74a8e5533f79411f171a1a2860a2e3a",
        "img_exp_transform": "extract_2d_from_3d"
    },
    "test": {
        "processor": "~/dev/fdq_diffusion/diffusion_monai.py",
        "test_model": "last",
        "args": {
            "nb_test_samples": 10
        }
    },
    "slurm_cluster": {
        "fdq_version": "0.0.70",
        "python_env_module": "python/3.12.4",
        "uv_env_module": "uv/0.6.12",
        "scratch_results_path": "/scratch/fdq_results/",
        "scratch_data_path": "/scratch/fdq_data/",
        "log_path": "~/dev/fdq_diffusion/slurm_log",
        "job_time": 1400,
        "stop_grace_time": 15,
        "ntasks": 1,
        "cpus_per_task": 16,
        "gres": "gpu:h200sxm:1",
        "mem": "120G",
        "partition": "gpu_top",
        "account": "cai_ivs",
        "run_train": true,
        "run_test": true,
        "auto_resubmit": true,
        "resume_chpt_path": null,
        "additional_pip_packages": [
            "h5py"
        ]
    }
}